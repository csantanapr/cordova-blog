<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
--><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width">
<meta name="generator" content="joDoc">
<title>Apache Cordova API Documentation</title>
<link rel="stylesheet" type="text/css" href="index.css">
<link rel="stylesheet" type="text/css" href="mobile.css" media="only screen and (max-device-width: 1024px)">
<link rel="stylesheet" type="text/css" href="prettify/prettify.css">
</head>
<body>
        <div id="header">
            <h1><a href="index.html">Apache <strong>Cordova</strong> Documentation</a></h1>
            <small>
                <select><optgroup label="English" value="en">
<option value="edge">edge</option>
<option value="2.8.0">2.8.0</option>
<option value="2.7.0rc1">2.7.0rc1</option>
<option value="2.7.0">2.7.0</option>
<option value="2.6.0rc1">2.6.0rc1</option>
<option value="2.6.0">2.6.0</option>
<option value="2.5.0rc1">2.5.0rc1</option>
<option value="2.5.0">2.5.0</option>
<option value="2.4.0rc1">2.4.0rc1</option>
<option value="2.4.0">2.4.0</option>
<option value="2.3.0rc2">2.3.0rc2</option>
<option value="2.3.0rc1">2.3.0rc1</option>
<option value="2.3.0">2.3.0</option>
<option value="2.2.0rc2">2.2.0rc2</option>
<option value="2.2.0rc1">2.2.0rc1</option>
<option value="2.2.0">2.2.0</option>
<option value="2.1.0rc2">2.1.0rc2</option>
<option value="2.1.0rc1">2.1.0rc1</option>
<option value="2.1.0">2.1.0</option>
<option value="2.0.0rc1">2.0.0rc1</option>
<option value="2.0.0">2.0.0</option>
<option value="1.9.0rc1">1.9.0rc1</option>
<option value="1.9.0">1.9.0</option>
<option value="1.8.1">1.8.1</option>
<option value="1.8.0rc1">1.8.0rc1</option>
<option value="1.8.0">1.8.0</option>
<option value="1.7.0rc1">1.7.0rc1</option>
<option value="1.7.0">1.7.0</option>
<option value="1.6.1">1.6.1</option>
<option value="1.6.0rc1">1.6.0rc1</option>
<option value="1.6.0">1.6.0</option>
<option value="1.5.0rc1">1.5.0rc1</option>
<option value="1.5.0">1.5.0</option>
</optgroup>
<optgroup label="Japanese" value="jp">
<option value="2.2.0">2.2.0</option>
<option selected value="2.1.0">2.1.0</option>
<option value="2.0.0">2.0.0</option>
<option value="1.9.0">1.9.0</option>
<option value="1.8.1">1.8.1</option>
<option value="1.7.0">1.7.0</option>
</optgroup>
<optgroup label="Korean" value="kr"><option value="2.0.0">2.0.0</option></optgroup></select></small>
        </div>
        <div id="subheader">
            <h1>Developing a Plugin on Android</h1>
            <small><select><option value="Developing%2520a%2520Plugin%2520on%2520Android">Developing a Plugin on Android</option>
<option value="Developing%20a%20Plugin%20on%20Android_">      - プラグインクラスのマッピング</option>
<option value="Developing%20a%20Plugin%20on%20Android_android_java">      - Android Java プラグインの作成</option>
<option value="Developing%20a%20Plugin%20on%20Android_">      - プラグインのデバッグ</option>
<option value="Developing%20a%20Plugin%20on%20Android_">      - よくある落とし穴</option></select></small>
        </div>

        <div id="sidebar">
            <div class="vertical_divider"></div>
        <h1>API リファレンス</h1>
<ul>
<li><a href="cordova_accelerometer_accelerometer.md.html#Accelerometer">Accelerometer</a></li>
<li><a href="cordova_camera_camera.md.html#Camera">Camera</a></li>
<li><a href="cordova_media_capture_capture.md.html#Capture">Capture</a></li>
<li><a href="cordova_compass_compass.md.html#Compass">Compass</a></li>
<li><a href="cordova_connection_connection.md.html#Connection">Connection</a></li>
<li><a href="cordova_contacts_contacts.md.html#Contacts">Contacts</a></li>
<li><a href="cordova_device_device.md.html#Device">Device</a></li>
<li><a href="cordova_events_events.md.html#Events">Events</a></li>
<li><a href="cordova_file_file.md.html#File">File</a></li>
<li><a href="cordova_geolocation_geolocation.md.html#Geolocation">Geolocation</a></li>
<li><a href="cordova_media_media.md.html#Media">Media</a></li>
<li><a href="cordova_notification_notification.md.html#Notification">Notification</a></li>
<li><a href="cordova_storage_storage.md.html#Storage">Storage</a></li>
</ul>
<h1>Guides</h1>
<ul>
<li><a href="guide_getting-started_index.md.html#%E5%85%A5%E9%96%80%E3%82%AC%E3%82%A4%E3%83%89">入門ガイド</a></li>
<li><a href="guide_command-line_index.md.html#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E4%BD%BF%E7%94%A8%E3%82%AC%E3%82%A4%E3%83%89">コマンドライン使用ガイド</a></li>
<li><a href="guide_upgrading_index.md.html#%E3%82%A2%E3%83%83%E3%83%97%E3%82%B0%E3%83%AC%E3%83%BC%E3%83%89%E3%82%AC%E3%82%A4%E3%83%89">アップグレードガイド</a></li>
<li><a href="guide_plugin-development_index.md.html#%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E9%96%8B%E7%99%BA%E3%82%AC%E3%82%A4%E3%83%89">プラグイン開発ガイド</a></li>
<li><a href="guide_whitelist_index.md.html#%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%9B%E3%83%AF%E3%82%A4%E3%83%88%E3%83%AA%E3%82%B9%E3%83%88%E3%82%AC%E3%82%A4%E3%83%89">ドメインホワイトリストガイド</a></li>
<li><a href="guide_cordova-webview_index.md.html#WebView%20%E3%81%AE%E5%9F%8B%E3%82%81%E8%BE%BC%E3%81%BF">WebView の埋め込み</a></li>
<li><a href="_index.html">索引</a></li>
</ul>
</div>

        <div id="scrollable">
            <div id="content">
                <h1><a name="Developing%20a%20Plugin%20on%20Android">Developing a Plugin on Android</a></h1>

<p>プラグインの開発には、 Cordova-Android のアーキテクチャの理解が必要です。
Cordova-Android は Android WebView とそれに付属するコールバックから構成されます。
これらのプラグインは config.xml ファイル内にクラスマッピングとして表されています。</p>

<p>プラグインは <code>Pluguin</code> クラスを継承した少なくとも1つの Java クラスによって構成されます。
プラグインは <code>PluginResult</code> オブジェクトを返す <code>execute</code> メソッドを <em>*必ず *</em>実装しなければなりません。
加えて、プラグイン作成のベストプラクティスとして、プラグインは <a href="cordova_events_events.md.html#pause">pause</a> と <a href="cordova_events_events.md.html#resume">resume</a> イベントをサポートし、またプラグイン間のメッセージのやりとりもサポートしているべきです。</p>

<h2>
<a name="Developing%20a%20Plugin%20on%20Android_">プラグインクラスのマッピング</a>
</h2>

<p>プラグインの JavaScript 部分は常に <code>cordova.exec</code> メソッドを以下のように使います:</p>

<pre class="prettyprint"><code>exec(&lt;successFunction&gt;, &lt;failFunction&gt;, &lt;service&gt;, &lt;action&gt;, [&lt;args&gt;]);
</code></pre>

<p>これは WebView から Android ネイティブ側へのリクエストを整理し、
おおよそ要約すると <code>service</code> クラスで <code>action</code> メソッドを、
<code>args</code> 配列で渡された引数と一緒に呼び出すということになります。</p>

<p>プラグインを Java ファイルで提供するしろ JAR でするにしろ、プラグインは必ず Cordova-Anroid アプリケーションの <code>res/xml</code> フォルダーにある <code>config.xml</code> ファイルに追加されていなければなりません。</p>

<pre class="prettyprint"><code>&lt;plugin name="&lt;service_name&gt;" value="&lt;full_name_including_namespace&gt;"/&gt;
</code></pre>

<p>サービス名 (name) は JavaScript の <code>exec</code> の中で定義したものと一致している必要があり、値 (value) は Java クラスへのネームスペースを含んだフルパスになります。これがないと、プラグインはコンパイルはされますが、
Cordova からアクセスできない状態となります。</p>

<h2>
<a name="Developing%20a%20Plugin%20on%20Android_android_java">Android Java プラグインの作成</a>
</h2>

<p>私たちはプラグインリクエストをネイティブ側に送る JavaScript を作成しました。
また、正しく <code>config.xml</code> ファイルでマッピングされた Android Java プラグインもあります。
では、最終的に Android Java プラグインのクラスがどのようになるのか見ていきましょう。</p>

<p>JavaScript の <code>exec</code> 関数によってプラグインに割り当てられたものは、
プラグインのクラスの <code>execute</code> メソッドに渡されます。大半の <code>execute</code>
の実装は以下のようになります:</p>

<pre class="prettyprint"><code>public PluginResult execute(String action, JSONArray args, String callbackId) {
    PluginResult.Status status = PluginResult.Status.OK;
    String result = "";

    try {
        if (action.equals("beep")) {
            this.beep(args.getLong(0));
        }
        return new PluginResult(status, result);
    } catch (JSONException e) {
        return new PluginResult(PluginResult.Status.JSON_EXCEPTION);
    }
}
</code></pre>

<p>基本的に <code>action</code> パラメーターの値を見て、クラス内の
(プライベート) メソッドに割り振っていきます。
また、任意でいくつかのパラメーターをそのメソッドに渡します。</p>

<p>例外をキャッチしエラーを返すとき、 JavaScript へ返すエラーが Java で発生した例外に可能なかぎり近づけることは、明瞭さのためにも重要です。</p>

<h3>Android プラグインの Echo プラグイン</h3>

<p>次を config.xml に追加します:</p>

<pre class="prettyprint"><code>&lt;plugin name="Echo" value="org.apache.cordova.plugin.Echo" /&gt;
</code></pre>

<p>そして、次を Cordova-Android アプリケーションの中の
<code>src/org/apache/cordova/plugin/Echo.java</code> に追加します:</p>

<pre class="prettyprint"><code>package org.apache.cordova.plugin;

import org.apache.cordova.api.Plugin;
import org.apache.cordova.api.PluginResult;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

/**
 * このクラスは JavaScript から呼び出された文字列をecho します。
 */
public class App extends Plugin {

    /**
     * リクエストを実行し、 PluginResult を返します。
     *
     * @param action        実行するアクション名です。
     * @param args          プラグインへの引数の JSONArry です。
     * @param callbackId    JavaScript へコールバックするときに使うコールバック id です。
     * @return              ステータスとメッセージを伴った PluginResult オブジェクトです。
     */
    public PluginResult execute(String action, JSONArray args, String callbackId) {
        try {
            if (action.equals("echo")) {
                String echo = args.getString(0);
                if (echo != null &amp;&amp; echo.length() &gt; 0) {
                    return new PluginResult(PluginResult.Status.OK, echo);
                } else {
                    return new PluginResult(PluginResult.Status.ERROR);
                }
            } else {
                return new PluginResult(PluginResult.Status.INVALID_ACTION);
            }
        } catch (JSONException e) {
            return new PluginResult(PluginResult.Status.JSON_EXCEPTION);
        }
    }
}
</code></pre>

<p>コードを見ていきましょう。一番上には、必要なすべての Cordova に関する
<code>import</code> 文が並んでいます。クラスは <code>Plugin</code> を継承しています - これはとても
重要です。 <code>Plugin</code> インターフェースは <code>execute</code> メソッドを実装する必要が
あります。メソッドは、最初に <code>action</code> を見ていきます。このプラグインは1つ
のアクション <code>echo</code> のみをサポートしています。ほかのアクションは、ステータス
が <code>INVALID_ACTION</code> となった <code>PluginResult</code> が返されます - これは JavaScript
側でエラーコールバックへの呼び出しに変換されます。次に、 <code>args</code> に対して
<code>getString</code> メソッドを使い、パラメーター配列から0番目のパラメーターを取得
することにより、 echo する文字列を取り出します。ここで、少しパラメーターに
対してチェックを行います: <code>null</code> チェックや文字列の長さが0でないかどうかなど
です。もしそうであった場合は、ステータスが <code>ERROR</code> の <code>PluginResult</code> を
返します (これはもうご存知の通り JavaScript 側でエラーコールバックを
呼び出します)。もしこれらのチェックをパスしたら、ステータスが <code>OK</code> の
<code>PluginResult</code> を返し、パラメーターとして受け取った <code>echo</code> 文字列を
渡します。これが、 JavaScript 側で成功コールバック関数に変換されます。
また、 <code>echo</code> パラメーターを JavaScript の成功コールバック関数に
パラメーターとして渡します。</p>

<h2>
<a name="Developing%20a%20Plugin%20on%20Android_">プラグインのデバッグ</a>
</h2>

<p>Eclipse は Android プロジェクトのデバッグに使用でき、 Java のソースファイルがプロジェクトに含まれている場合は、プラグインもデバッグできます。最新バージョンの Android Dev Tools のみ JAR にソースコードを付与でき、これは今回はフルでサポートされていません。</p>

<h2>
<a name="Developing%20a%20Plugin%20on%20Android_">よくある落とし穴</a>
</h2>

<ul>
<li>プラグインは <code>CordovaInterface</code> オブジェクトへのアクセス権を持っています。このオブジェクトはアプリケーションで走っている Android の <code>Activity</code> へのアクセス権を持っています。この <code>Activity</code> は新しい Android <code>Intent</code> を起動するために必要な <code>Context</code> です。
<code>CordovaInterface</code> は、結果として <code>Activity</code> を開始すること、また <code>Intent</code> がアプリケーションに戻ってきたときにコールバックをセットすることをプラグインに許可します。
<code>Intent</code> システムは Android のプロセス間の連携に使われるため、これは非常に重要です。</li>
<li>プラグインは <code>Context</code> への直接アクセス権を以前のように持っていません。以前の <code>ctx</code> はもう廃止され、 2.0 リリースの6ヶ月後に削除されます。 <code>Context</code> にあった <code>ctx</code> が存在するすべてのメソッド、 <code>getContext()</code> と <code>getActivity()</code> は必要な正しいオブジェクトを返すことが可能です。</li>
<li>
<code>webView.loadUrl()</code> を使って JavaScript を呼び出すことは避けてください。コールバックサーバーがある理由は、 JavaScript がスレッドセーフで実行されるためです。 <code>loadUrl</code> は明確に UI スレッドに割り込み、プラグインのユーザビリティーに影響します。</li>
</ul>
</div>
        </div>

        <!-- Functionality and Syntax Highlighting -->
        <script type="text/javascript" src="index.js"></script><script type="text/javascript" src="prettify/prettify.js"></script>
</body>
</html>
